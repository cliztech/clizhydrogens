name: Hydrogen Preview → Perf → QA → Prod

on:
  push:
    branches:
      - work
    paths:
      - 'app/**'
      - 'config/**'
      - 'locales/**'
      - 'scripts/**'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/hydrogen-orchestration.yml'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy'
        required: false
        default: 'work'
      skip_perf:
        description: 'Skip performance loop'
        required: false
        default: 'false'
      skip_qa:
        description: 'Skip Playwright/axe tests'
        required: false
        default: 'false'

permissions:
  contents: read
  id-token: write

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci

  deploy_preview:
    runs-on: ubuntu-latest
    needs: install
    environment:
      name: preview
    outputs:
      preview_url: ${{ steps.capture-preview.outputs.preview_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build Hydrogen app
        run: npm run build
      - name: Deploy to Oxygen preview
        id: oxygen
        env:
          SHOPIFY_CLI_TOKEN: ${{ secrets.SHOPIFY_CLI_TOKEN }}
          SHOPIFY_HYDROGEN_PROJECT_ID: ${{ secrets.SHOPIFY_HYDROGEN_PROJECT_ID }}
        run: |
          npx shopify hydrogen deploy --environment=preview --json > deployment.json
      - name: Capture preview URL
        id: capture-preview
        run: |
          PREVIEW_URL=$(jq -r '.preview_url // .url // empty' deployment.json)
          if [ -z "$PREVIEW_URL" ]; then
            echo "Failed to read preview URL from deployment.json"
            cat deployment.json
            exit 1
          fi
          echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
      - name: Upload deployment manifest
        uses: actions/upload-artifact@v4
        with:
          name: preview-deployment
          path: deployment.json

  perf_loop:
    runs-on: ubuntu-latest
    needs: deploy_preview
    if: ${{ github.event.inputs.skip_perf != 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run performance loop
        env:
          PREVIEW_URL: ${{ needs.deploy_preview.outputs.preview_url }}
          PERF_BUDGET_LCP_MS: 2000
          PERF_BUDGET_CLS: 0.1
          PERF_BUDGET_INP_MS: 200
        run: npx tsx scripts/run-perf-loop.ts

  qa_tests:
    runs-on: ubuntu-latest
    needs:
      - deploy_preview
      - perf_loop
    if: ${{ github.event.inputs.skip_qa != 'true' && (needs.perf_loop.result == 'success' || github.event.inputs.skip_perf == 'true') }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Run Playwright + axe suites
        env:
          PREVIEW_URL: ${{ needs.deploy_preview.outputs.preview_url }}
        run: npm run test -- --reporter=line
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore

  deploy_production:
    runs-on: ubuntu-latest
    needs:
      - qa_tests
    if: ${{ needs.qa_tests.result == 'success' }}
    environment:
      name: production
      url: ${{ steps.capture-prod.outputs.production_url }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Build Hydrogen app
        run: npm run build
      - name: Deploy to Oxygen production
        env:
          SHOPIFY_CLI_TOKEN: ${{ secrets.SHOPIFY_CLI_TOKEN }}
          SHOPIFY_HYDROGEN_PROJECT_ID: ${{ secrets.SHOPIFY_HYDROGEN_PROJECT_ID }}
        run: |
          npx shopify hydrogen deploy --environment=production --json > prod-deployment.json
      - name: Capture production URL
        id: capture-prod
        run: |
          PRODUCTION_URL=$(jq -r '.production_url // .url // empty' prod-deployment.json)
          if [ -z "$PRODUCTION_URL" ]; then
            echo "Failed to read production URL from prod-deployment.json"
            cat prod-deployment.json
            exit 1
          fi
          echo "production_url=$PRODUCTION_URL" >> "$GITHUB_OUTPUT"
      - name: Upload production manifest
        uses: actions/upload-artifact@v4
        with:
          name: production-deployment
          path: prod-deployment.json
      - name: Smoke test production
        env:
          PREVIEW_URL: ${{ steps.capture-prod.outputs.production_url }}
        run: npx playwright test tests/e2e/core-flow.spec.ts --reporter=line --project=chromium

  notify:
    runs-on: ubuntu-latest
    needs:
      - deploy_preview
      - qa_tests
      - deploy_production
    if: always()
    steps:
      - name: Post summary
        uses: actions/github-script@v7
        with:
          script: |
            const preview = '${{ needs.deploy_preview.outputs.preview_url || '' }}';
            const qaResult = '${{ needs.qa_tests.result || 'skipped' }}';
            const prod = '${{ needs.deploy_production.result || 'skipped' }}';
            core.summary
              .addHeading('Cheeky Prints Deployment Summary')
              .addList([
                `Preview URL: ${preview || 'n/a'}`,
                `QA status: ${qaResult}`,
                `Production deploy: ${prod}`,
              ])
              .write();
